#!/bin/bash

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
FEATURES_DIR="$SCRIPT_DIR/features"

# Source common functions and variables
source "$FEATURES_DIR/common.sh"

# Source all feature modules
source "$FEATURES_DIR/reconnaissance.sh"
source "$FEATURES_DIR/webshell.sh"
source "$FEATURES_DIR/ssh_injection.sh"
source "$FEATURES_DIR/database_dump.sh"
source "$FEATURES_DIR/cron_injection.sh"

# Main execution
main() {
  # Validate inputs and set global variables
  validate_inputs "$@"
  
  # Connect to Redis
  connect_to_redis
  
  # Main menu
  echo -e "\n${BLUE}=== Redis CTF Exploitation Tool ===${NC}"
  echo -e "Connected to Redis. Select an action:\n"
  echo -e "${YELLOW}1.${NC} Reconnaissance (gather info)"
  echo -e "${YELLOW}2.${NC} Inject PHP web shell"
  echo -e "${YELLOW}3.${NC} Dump database to disk"
  echo -e "${YELLOW}4.${NC} Inject SSH key for access"
  echo -e "${YELLOW}5.${NC} Inject cron job"
  echo -e "${YELLOW}6.${NC} Exit"
  echo
  read -p "Enter your choice (1-6): " choice

  case $choice in
    1) reconnaissance ;;
    2) inject_user_shell ;;
    3) dump_database ;;
    4) inject_ssh_key ;;
    5) inject_cron_job ;;
    6) echo -e "${BLUE}[*]${NC} Exiting..."; exit 0 ;;
    *) echo -e "${RED}[-]${NC} Invalid choice. Exiting."; exit 1 ;;
  esac
}

# Run main function with all arguments
main "$@"